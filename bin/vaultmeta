# vaultmeta
#!/usr/bin/env bash
set -euo pipefail

SCRIPT_NAME="vaultmeta"
VERSION="0.0.1-phase0"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
USER_CONFIG_DIR="${XDG_CONFIG_HOME}/vaultmeta"
USER_CONFIG_FILE="${USER_CONFIG_DIR}/vaultmeta.conf"

REPO_CONFIG_FILE="${REPO_ROOT}/config/vaultmeta.conf"
REPO_CONFIG_EXAMPLE="${REPO_ROOT}/config/vaultmeta.conf.example"

now_iso() { date +"%Y-%m-%dT%H:%M:%S%z"; }

trim() { echo "${1:-}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'; }

die() { echo "ERROR: $*" >&2; exit 1; }

prompt() {
  local msg="$1"
  local def="${2:-}"
  local ans=""
  if [[ -n "${def}" ]]; then
    read -r -p "${msg} [default: ${def}] " ans || true
    ans="$(trim "$ans")"
    [[ -z "$ans" ]] && ans="$def"
  else
    read -r -p "${msg} " ans || true
    ans="$(trim "$ans")"
  fi
  echo "$ans"
}

csv_to_lines() {
  local csv="${1:-}"
  [[ -z "$csv" ]] && return 0
  echo "$csv" | tr ',' '\n' | while IFS= read -r line; do
    line="$(trim "$line")"
    [[ -n "$line" ]] && echo "$line"
  done
}

resolve_config_file() {
  # Priority:
  # 1) VAULTMETA_CONFIG
  # 2) XDG user config
  # 3) repo config (when running from repo)
  if [[ -n "${VAULTMETA_CONFIG:-}" ]]; then
    echo "${VAULTMETA_CONFIG}"
    return 0
  fi
  if [[ -f "${USER_CONFIG_FILE}" ]]; then
    echo "${USER_CONFIG_FILE}"
    return 0
  fi
  if [[ -f "${REPO_CONFIG_FILE}" ]]; then
    echo "${REPO_CONFIG_FILE}"
    return 0
  fi
  echo ""
}

load_config() {
  local cfg
  cfg="$(resolve_config_file)"
  if [[ -z "$cfg" || ! -f "$cfg" ]]; then
    die "Config not found. Looked for:
- VAULTMETA_CONFIG (env override)
- ${USER_CONFIG_FILE}
- ${REPO_CONFIG_FILE}
Create one via: ./install.sh install"
  fi

  # shellcheck disable=SC1090
  source "$cfg"

  INCLUDE_HIDDEN="${INCLUDE_HIDDEN:-0}"
  EXCLUDE_DIRS="${EXCLUDE_DIRS:-.git,node_modules}"
  EXCLUDE_GLOBS="${EXCLUDE_GLOBS:-}"
  TREE_MAX_DEPTH="${TREE_MAX_DEPTH:-6}"
  FOLLOW_SYMLINKS="${FOLLOW_SYMLINKS:-0}"
  INCLUDE_FILES="${INCLUDE_FILES:-1}"
  OUTPUT_DIR="${OUTPUT_DIR:-}"
  VAULT_ROOT="${VAULT_ROOT:-}"

  RESOLVED_CONFIG_FILE="$cfg"
}

ensure_paths_resilient() {
  while [[ -z "${VAULT_ROOT:-}" || ! -d "${VAULT_ROOT}" ]]; do
    if [[ -n "${VAULT_ROOT:-}" && ! -d "${VAULT_ROOT}" ]]; then
      echo "Missing vault root directory: ${VAULT_ROOT}"
    fi
    VAULT_ROOT="$(prompt "Enter VAULT_ROOT (path to your Obsidian vault root):" "")"
  done

  local default_out="${VAULT_ROOT%/}/30_REFERENCE/vaultmeta"
  if [[ -z "${OUTPUT_DIR:-}" ]]; then
    OUTPUT_DIR="$(prompt "Enter output directory or press Enter to accept default:" "${default_out}")"
  fi

  if [[ ! -d "${OUTPUT_DIR}" ]]; then
    mkdir -p "${OUTPUT_DIR}" || die "Failed to create OUTPUT_DIR: ${OUTPUT_DIR}"
  fi
}

settings_summary() {
  cat <<EOF
- CONFIG_FILE: ${RESOLVED_CONFIG_FILE}
- VAULT_ROOT: ${VAULT_ROOT}
- OUTPUT_DIR: ${OUTPUT_DIR}
- INCLUDE_HIDDEN: ${INCLUDE_HIDDEN}
- EXCLUDE_DIRS: ${EXCLUDE_DIRS}
- EXCLUDE_GLOBS: ${EXCLUDE_GLOBS}
- TREE_MAX_DEPTH: ${TREE_MAX_DEPTH}
- FOLLOW_SYMLINKS: ${FOLLOW_SYMLINKS}
- INCLUDE_FILES: ${INCLUDE_FILES}
EOF
}

write_header() {
  local title="$1"
  cat <<EOF
---
type: vaultmeta-report
title: ${title}
generated: $(now_iso)
vault_root: ${VAULT_ROOT}
output_dir: ${OUTPUT_DIR}
version: ${VERSION}
---

## Settings Summary

$(settings_summary)

---
EOF
}

build_find_args() {
  FIND_ARGS=()

  if [[ "${FOLLOW_SYMLINKS}" == "1" ]]; then
    FIND_ARGS+=("-L")
  fi

  FIND_ARGS+=("${VAULT_ROOT}")
  FIND_ARGS+=("-maxdepth" "${TREE_MAX_DEPTH}")

  if [[ "${INCLUDE_HIDDEN}" != "1" ]]; then
    FIND_ARGS+=("(" "-path" "*/.*" ")" "-prune" "-o")
  fi

  local d
  while IFS= read -r d; do
    FIND_ARGS+=("(" "-name" "${d}" "-type" "d" ")" "-prune" "-o")
  done < <(csv_to_lines "${EXCLUDE_DIRS}")

  local g
  while IFS= read -r g; do
    FIND_ARGS+=("(" "-name" "${g}" ")" "-prune" "-o")
  done < <(csv_to_lines "${EXCLUDE_GLOBS}")

  if [[ "${INCLUDE_FILES}" == "1" ]]; then
    FIND_ARGS+=("-print")
  else
    FIND_ARGS+=("-type" "d" "-print")
  fi
}

report_tree() {
  ensure_paths_resilient
  build_find_args

  local out="${OUTPUT_DIR%/}/VaultMeta - File Tree.md"
  {
    write_header "VaultMeta - File Tree"
    echo "# ðŸŒ¿ VaultMeta â€” File Tree"
    echo
    echo "_Stable note. Overwritten each run._"
    echo
    echo "## Tree"
    echo

    find "${FIND_ARGS[@]}" \
      | sed "s#^${VAULT_ROOT%/}/##" \
      | sed 's#^$#.#' \
      | sort \
      | awk -F'/' '
        {
          depth = NF - 1
          indent = ""
          for (i=0; i<depth; i++) indent = indent "  "
          name = $NF
          if ($0 == ".") { name="(vault root)"; indent="" }
          print indent "- " name
        }'
  } > "${out}"
  echo "Wrote: ${out}"
}

report_dirs() {
  ensure_paths_resilient

  local old_include_files="${INCLUDE_FILES}"
  INCLUDE_FILES="0"
  build_find_args
  INCLUDE_FILES="${old_include_files}"

  local out="${OUTPUT_DIR%/}/VaultMeta - Directory Blocks.md"
  {
    write_header "VaultMeta - Directory Blocks"
    echo "# ðŸ“ VaultMeta â€” Directory Blocks"
    echo
    echo "_Stable note. Overwritten each run._"
    echo
    echo "## Directories"
    echo

    echo '```bash'
    echo "${VAULT_ROOT}"
    echo '```'
    echo

    find "${FIND_ARGS[@]}" -type d \
      | sort \
      | while IFS= read -r dir; do
          [[ "${dir%/}" == "${VAULT_ROOT%/}" ]] && continue
          echo '```bash'
          echo "${dir}"
          echo '```'
          echo
        done
  } > "${out}"
  echo "Wrote: ${out}"
}

cmd_status() {
  ensure_paths_resilient
  echo "${SCRIPT_NAME} ${VERSION}"
  echo
  settings_summary
}

usage() {
  cat <<EOF
${SCRIPT_NAME} ${VERSION}

Usage:
  vaultmeta                Run all reports (tree + dirs)
  vaultmeta tree           Generate File Tree report
  vaultmeta dirs           Generate Directory Blocks report
  vaultmeta status         Print resolved config and effective settings
  vaultmeta help           Show this help

Config search order:
  1) VAULTMETA_CONFIG (env override)
  2) ${USER_CONFIG_FILE}
  3) ${REPO_CONFIG_FILE}

EOF
}

main() {
  local cmd="${1:-}"
  load_config

  case "${cmd}" in
    "" ) report_tree; report_dirs ;;
    tree ) report_tree ;;
    dirs ) report_dirs ;;
    status ) cmd_status ;;
    help|-h|--help ) usage ;;
    * ) echo "Unknown command: ${cmd}" >&2; usage; exit 2 ;;
  esac
}

main "$@"

# vaultmeta EOF
